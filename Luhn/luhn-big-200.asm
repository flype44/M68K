;==========================================================
; ASM Testcase
; flype, 2015-09-26
; luhn_checksum()
;==========================================================
; http://www.simplycalc.com/luhn-source.php
;==========================================================

;==========================================================
; Constants
;==========================================================

ASSERT_ZERO EQU $00D0000C

;==========================================================
; MAIN()
; A0 = VALUES
; A1 = PRECALC
; D0 = Result
; D1 = Value Bytes Length
; D7 = Total Result
;==========================================================

;	DC.L	0
;	DC.L	START
;	SECTION .FASTRAM

START:
	LEA		VALUES,A0		; Values
	LEA		PRECALC,A1		; Checksums
	CLR.L	D7				; Total Result
LOOP:
	CLR.L	D0				; Result
	CLR.L	D1				; Value Bytes Length
	MOVE.B	(A0),D1			; Read length
	JSR		LUHN			; Luhn(Value)
	ADD.L	D0,D7			; Total Result
	SUB.B	(A1)+,D0		; Result - Precalc
	MOVE.L	D0,ASSERT_ZERO	; Assert D0 == 0
	MOVE.B	(A0),D1			; Read length
	ADD.L	D1,A0			; Next Value
	ADD.L	#1,A0			; 
	CMP.B	#0,(A0)			; Check if last value
	BNE		LOOP			; Continue while != 0
EXIT:
	SUB.W	(A1),D7			; Total Result - Total Precalc
	MOVE.L	D0,ASSERT_ZERO	; Assert D0 == 0
	TST		$0				; FLUSH
	;STOP	#-1				; STOP SIM
	RTS

;==========================================================
; LUHN()
; Input  : A0 = Value
; Input  : D1 = Value Bytes Length
; Output : D0 = Checksum
;==========================================================

LUHN:
	CLR.L	D0				; Checksum
	CLR.L	D3				; Digit
	MOVE.L	D1,D2			; Parity = Length
	ANDI.L	#1,D2			; Parity % 2
	SUBI.L	#1,D1			; Length - 1
LUHNLOOP:
	MOVE.B	1(A0,D1),D3		; Digit = code.charAt(i)
	SUBI.B 	#$30,D3			; Digit = parseInt(Digit)
	MOVE.L	D1,D4			; i
	ANDI.L	#1,D4			; i % 2
	CMP.L	D4,D2			; Compare D4 and D2
	BNE		LUHNNEXT1		; If (i % 2 == Parity)
	LSL.L	#1,D3			; Digit * 2
LUHNNEXT1:
	CMPI.L	#9,D3			; Compare 9 and D3
	BLE		LUHNNEXT2		; If (Digit > 9)
	SUBI.L	#9,D3			; Digit - 9
LUHNNEXT2:
	ADD.L	D3,D0			; Checksum + Digit
	DBF		D1,LUHNLOOP		; Continue
LUHNEXIT:
	DIVU.W	#10,D0			; Checksum / 10
	SWAP	D0				; 
	MOVE.W	D0,D1			; Checksum % 10
	MOVE.L	#10,D0			; 
	SUB.L	D1,D0			; 10 - Checksum
	RTS						; return Checksum

;==========================================================
; Data Section
;==========================================================

VALUES:
 DC.B 41,'79355337134515684911335257263615865790500'
 DC.B 55,'2935927644935043171260592781385361738423132881926738660'
 DC.B 29,'56786803780566337195005043880'
 DC.B 60,'401045753731224963588875210023797285764799529550533325236330'
 DC.B 45,'579660748779134305704280371507523667341810350'
 DC.B 54,'090949191813259694542652193756226237586397954949820550'
 DC.B 38,'56050893042362120216676564869909263700'
 DC.B 22,'2129175366598799419400'
 DC.B 60,'185605895087410509705244462040094393625087755421744066720650'
 DC.B 51,'618754012528866284029966276608288742233521914273990'
 DC.B 23,'09140318935981943378650'
 DC.B 43,'6318603938298928085424754632089817921692250'
 DC.B 54,'120873610081210772013545188878501726010872588691190540'
 DC.B 34,'2764892001653036247926644579196960'
 DC.B 57,'968099217198297638876376953842207634096542219131186407610'
 DC.B 34,'4989800755332555298537934907160470'
 DC.B 44,'44454631129432045146168898346126782544616120'
 DC.B 47,'34712630766927177954815454981441308758680633530'
 DC.B 28,'1473418391235244740222535230'
 DC.B 59,'44286517334808170808120167872936623009861683048522853565470'
 DC.B 38,'37502152474805972636511793513220804410'
 DC.B 48,'555478825409871379623402448563785853217778838710'
 DC.B 37,'0366064837431314521123170659455759110'
 DC.B 46,'3484768012557243247561240108582430283704872340'
 DC.B 59,'37666999680705925516783867698431718575800087487612223402460'
 DC.B 56,'63834431978484379892076168671305563744923398528173842450'
 DC.B 60,'753986087418619947863299283000230557480047736586973547800730'
 DC.B 33,'822054251286839299074521657913250'
 DC.B 51,'931761231683107566822224399211246194940665150698650'
 DC.B 18,'626086768634957620'
 DC.B 21,'978292963535484921250'
 DC.B 51,'173553428207035267036424104567493421661066961589490'
 DC.B 51,'218928513278066272885536164078551500642521031779500'
 DC.B 49,'0864114090428258525833977845922513893843226296920'
 DC.B 33,'290042703407010464038692708940060'
 DC.B 33,'145201536313427369631146655577960'
 DC.B 45,'823283611877207944825888749867563816921696820'
 DC.B 29,'11461796746168416302936592760'
 DC.B 17,'62664318054108320'
 DC.B 46,'5872783001954321612317547090810515101891314640'
 DC.B 37,'0408341718447230425382911417138339150'
 DC.B 27,'611841308612177614135302820'
 DC.B 39,'850593026081006803604641445280702999270'
 DC.B 51,'215733733659399782996085899265100978727100503383820'
 DC.B 39,'878778511234092397922248773211407735460'
 DC.B 52,'2391559818260356119239688524898347610223098180026350'
 DC.B 17,'87268470087007180'
 DC.B 35,'60227179410530879988162380543398040'
 DC.B 40,'2429118336823336998846885848131432867970'
 DC.B 41,'06513624502376365628400135123942167091580'
 DC.B 61,'9358419648702422746082930809503670249242075679598120453479890'
 DC.B 59,'20672300308513130678382213862426399981459758655506076287660'
 DC.B 37,'3764310289300001861159723857117399850'
 DC.B 45,'650417238167781171971401853901815502168137790'
 DC.B 58,'1248028430322397477536581293529688482300031917363815641960'
 DC.B 31,'7756999174962344498114076755310'
 DC.B 39,'197977936028517903627555485034623917560'
 DC.B 21,'225693653388334550320'
 DC.B 57,'723710333175800613458030505807006084160719836866606284650'
 DC.B 36,'860095899067639599129284355908353510'
 DC.B 17,'17273836824296490'
 DC.B 51,'427389343361946369126757212204573095608544581863560'
 DC.B 50,'69566941584091021837028071051104610323404347742600'
 DC.B 16,'7662384712851900'
 DC.B 21,'182897523315445372280'
 DC.B 47,'69906541833164624249111061970207779587828183980'
 DC.B 37,'4552759758616489153064418094869535780'
 DC.B 60,'701648094893488031230462644744144190020183010274102167182310'
 DC.B 22,'2375675622134112962540'
 DC.B 40,'2650988287099588737631750675622272780250'
 DC.B 53,'78334098545888621836360792716153715680590488841022540'
 DC.B 38,'02495603133207122336345890241620958840'
 DC.B 59,'61455288573932836859308208393530639585668681362307989925280'
 DC.B 54,'619263405604727776687701011400607222728686178158399330'
 DC.B 26,'82310153744413981767294230'
 DC.B 61,'5334290453671121170411144447779357041501417573937755887007450'
 DC.B 60,'456700747034312486538704021910504841972286280257261652851450'
 DC.B 60,'141004025431754862756239364077476747365974491118979342813770'
 DC.B 49,'8462780376896491631930955523427147667588887370090'
 DC.B 26,'93808589700465244900263120'
 DC.B 31,'0685081321784845736786629402660'
 DC.B 51,'151715561906483787754702365810332025797917441645550'
 DC.B 60,'075405275675498468509120525973930065664931459109055213928750'
 DC.B 31,'0058000335344018872740941615640'
 DC.B 47,'47740253668551076690466006034042998100529026480'
 DC.B 21,'422637331198655397840'
 DC.B 39,'158679047143631439962682294910202804430'
 DC.B 57,'446427736885254085762377910067966665886364745948316687040'
 DC.B 28,'7358243114481847227973965290'
 DC.B 36,'999621957781815111350034356360190790'
 DC.B 22,'5972114920236142196380'
 DC.B 38,'63313665960248578936751227729677143510'
 DC.B 52,'1173572601678063302758316725417105764790064172813270'
 DC.B 51,'641982188330958611926856507141777020157058748370090'
 DC.B 37,'6722260495257275330501888949839839760'
 DC.B 57,'399786336605156991873674170164434027739043735113626697280'
 DC.B 53,'21166346931685828574796677700187979746310741577500270'
 DC.B 33,'197310248643324427130449289573680'
 DC.B 40,'8580571412497261813543273704430284637730'
 DC.B 45,'823364154560572543102742081921571807817205250'
 DC.B 44,'83699475737495520663980252976249938418282230'
 DC.B 45,'393748171361779234809101012416868997367834610'
 DC.B 21,'738874793702000433090'
 DC.B 34,'0126852008300839291965186513447890'
 DC.B 53,'84508180271674696100989038310107562630454997560159700'
 DC.B 18,'891652961652730530'
 DC.B 60,'742993417897707363737960197021361536110984687728866045921580'
 DC.B 54,'174034692776971357523490741730191440195896394864379450'
 DC.B 34,'2424711974025631232230111138495710'
 DC.B 35,'22167502950100954508390298324032200'
 DC.B 57,'101727843490338199259627443120361573938126330704545832460'
 DC.B 51,'658444602285498201525971910227144934400887709106990'
 DC.B 44,'70637653796971516920462350316070543563773220'
 DC.B 21,'518393506662620714860'
 DC.B 57,'032654422812949871766093712032053615963766348455214665460'
 DC.B 24,'034199041073545654644400'
 DC.B 27,'510256399586330098282763960'
 DC.B 30,'047911319768007000825541435440'
 DC.B 36,'919775540240620028181092598633441450'
 DC.B 55,'7968947943686089780943298426965807925454891477360471590'
 DC.B 44,'96808423371222725363265321168316483489496640'
 DC.B 24,'244759935970987162207490'
 DC.B 43,'7210876141854243199471216643107596987379360'
 DC.B 59,'01446539352650766318333139223203162394640401161442690499940'
 DC.B 31,'6406056941611761964132061663520'
 DC.B 22,'1244280751263231890250'
 DC.B 33,'766117152555507454532285792823300'
 DC.B 33,'391091901356768929358745696924180'
 DC.B 23,'34239255850705204891810'
 DC.B 38,'90684592964569069551110835838894594800'
 DC.B 34,'6186514729875657461876058136730670'
 DC.B 22,'1661697928810593869720'
 DC.B 21,'956856345244291512440'
 DC.B 39,'595930772760560438781642849219471850500'
 DC.B 25,'9593202261423007326064990'
 DC.B 49,'6769440491482846243766933047618713142905470794070'
 DC.B 46,'8312483715298109255940335755206223723019764750'
 DC.B 26,'22681416521614842117389350'
 DC.B 56,'80617041218488765342008054296025023979762104587122788710'
 DC.B 46,'9280502145920248295676240806766288435253718920'
 DC.B 51,'822741174438936927512668889534205852706534954155140'
 DC.B 32,'03499505034615255026038265329060'
 DC.B 31,'7123997290206716287696878959060'
 DC.B 41,'74257132046972458639624061863617735524530'
 DC.B 21,'902840618317879985550'
 DC.B 49,'4290279977555914326637820526924086090108750844770'
 DC.B 46,'4747143270645291117867483276162278901387905650'
 DC.B 18,'875918168613959370'
 DC.B 28,'4498521403611225479601594170'
 DC.B 28,'7298540573945244794668086910'
 DC.B 40,'5320713189775901966994881793873547891880'
 DC.B 55,'9420655815267760164768313135961712296953973344483866460'
 DC.B 54,'073428189560730911038400286672980574924323311836039650'
 DC.B 17,'02701743448421000'
 DC.B 27,'787780358330881711482305180'
 DC.B 46,'3247524114913191163786917275692819126498384990'
 DC.B 19,'1026142825900832050'
 DC.B 17,'33795577351823100'
 DC.B 51,'413396769765175923748365813389952731547745509424460'
 DC.B 33,'344514048131599777019498976779430'
 DC.B 34,'9128675934269074604852365601919810'
 DC.B 42,'484847308539918097297195984270250115386820'
 DC.B 39,'383293956498913638159577532921217550510'
 DC.B 39,'406525691730154820948122021139840547710'
 DC.B 54,'467265103438742874759368248817734257778427069707969820'
 DC.B 48,'482990268160135725903343942343164306850122375780'
 DC.B 23,'70307811045742830752410'
 DC.B 49,'1763050450866717815994669695533318746325818329140'
 DC.B 40,'3516535498576726877853660172720870152830'
 DC.B 56,'66688066783023713768910401175787194175935575667470572280'
 DC.B 26,'12618406155794596395002620'
 DC.B 16,'3069955826070380'
 DC.B 50,'32852559486419695846040831940774277915829476176530'
 DC.B 53,'31507679421089411392824509661602030702507492169896050'
 DC.B 52,'9661047477529904792426776889196179382006023620192420'
 DC.B 22,'3392603435672507252940'
 DC.B 38,'43091624506611904001346418776672126600'
 DC.B 17,'73242348385831350'
 DC.B 48,'699587990329318027287505628435351062186872979800'
 DC.B 43,'7391367025723259692001726853188641991248150'
 DC.B 53,'14257314414196335324955593363716747009738950125243410'
 DC.B 48,'271579434579826536171012720213273184051966534180'
 DC.B 24,'779959129591051415537860'
 DC.B 20,'18597349496994535340'
 DC.B 25,'4181079026297934091416210'
 DC.B 44,'78292961360792916175754428972891792621864270'
 DC.B 40,'2600898474411322456086057644010949804740'
 DC.B 35,'69760163725801653753902614481512320'
 DC.B 42,'868077654484373905958826761799177274744810'
 DC.B 16,'6222341844600690'
 DC.B 29,'02261676028067497813070722450'
 DC.B 23,'57191153524672594024310'
 DC.B 45,'141612328681792995035772825833930730869592870'
 DC.B 40,'3071180541136374779069690428023672094600'
 DC.B 43,'0424105220615877267575802408344312982854960'
 DC.B 30,'882703609854323178918735428240'
 DC.B 53,'31411705032710072061970409906905893044845182711524290'
 DC.B 43,'7640514596288492622781451241728124710430310'
 DC.B 19,'1464770864492576260'
 DC.B 17,'82314376695102600'
 DC.B 0
 DC.B 0

PRECALC:
 DC.B 02,07,07,06,02,05,10,06,06,05
 DC.B 02,01,04,03,07,02,09,04,05,08
 DC.B 06,01,02,03,06,06,09,02,01,06
 DC.B 10,10,07,07,03,05,05,09,02,04
 DC.B 02,10,05,02,07,03,02,01,06,09
 DC.B 04,03,05,08,05,05,06,04,06,01
 DC.B 06,06,04,08,06,07,04,09,10,05
 DC.B 03,03,06,01,08,02,05,06,01,10
 DC.B 05,08,06,04,07,03,08,10,06,07
 DC.B 04,10,07,04,09,08,04,06,09,04
 DC.B 02,04,03,07,06,08,10,09,06,02
 DC.B 10,07,01,05,07,10,03,02,08,04
 DC.B 09,10,03,06,06,09,10,04,03,08
 DC.B 05,02,07,06,08,07,03,10,01,06
 DC.B 10,07,10,09,04,10,08,09,07,09
 DC.B 01,05,04,01,03,08,09,06,01,06
 DC.B 09,06,07,10,05,07,03,06,04,10
 DC.B 03,02,06,08,06,10,05,07,08,03
 DC.B 07,08,04,07,01,04,10,02,05,09
 DC.B 09,06,07,09,06,06,08,05,03,01
 DC.W 1144

;==========================================================
; End of file
;==========================================================
